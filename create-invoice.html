<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InFree - 請求書作成</title>
  <link rel="stylesheet" href="common.css">
  <style>
    /* Page-specific styles for create-invoice */
    .create-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Form Section */
    .form-section {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f3f4f6;
    }

    .section-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .section-icon svg {
      width: 18px;
      height: 18px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    /* Invoice Preview */
    .preview-section {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 2px solid #f3f4f6;
    }

    .preview-logo {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .preview-info {
      text-align: right;
    }

    .invoice-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .invoice-number {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }

    .preview-parties {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .party-info h3 {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .party-details {
      font-size: 14px;
      color: #374151;
      line-height: 1.6;
    }

    .party-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    /* Items Table */
    .invoice-items {
      margin-bottom: 32px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .items-table th {
      background: #f9fafb;
      padding: 12px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e5e7eb;
    }

    .items-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      color: #374151;
    }

    .items-table .item-name {
      font-weight: 500;
      color: #1f2937;
    }

    .items-table .text-right {
      text-align: right;
    }

    /* Totals */
    .invoice-totals {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid #e5e7eb;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .total-label {
      color: #6b7280;
    }

    .total-value {
      font-weight: 600;
      color: #1f2937;
    }

    .total-row.grand-total {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #e5e7eb;
      font-size: 18px;
    }

    .total-row.grand-total .total-label {
      color: #1f2937;
      font-weight: 600;
    }

    .total-row.grand-total .total-value {
      color: #667eea;
      font-size: 24px;
    }

    /* Item Row Management */
    .item-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 40px;
      gap: 12px;
      margin-bottom: 12px;
      align-items: start;
    }

    .remove-item-btn {
      height: 44px;
      width: 44px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #ef4444;
    }

    .remove-item-btn:hover {
      background: #fef2f2;
      border-color: #fecaca;
    }

    .add-item-btn {
      width: 100%;
      height: 44px;
      background: #ffffff;
      border: 2px dashed #d1d5db;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #6b7280;
      font-size: 15px;
      font-weight: 500;
      margin-top: 12px;
    }

    .add-item-btn:hover {
      border-color: #667eea;
      background: #f8faff;
      color: #667eea;
    }

    /* Templates */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .template-card {
      padding: 16px;
      background: #ffffff;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .template-card:hover {
      border-color: #667eea;
      background: #f8faff;
    }

    .template-name {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .template-desc {
      font-size: 12px;
      color: #6b7280;
    }

    /* Actions */
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #f3f4f6;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .create-container {
        grid-template-columns: 1fr;
      }

      .preview-section {
        position: static;
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      .form-section,
      .preview-section {
        padding: 20px;
      }

      .item-row {
        grid-template-columns: 1fr;
      }

      .remove-item-btn {
        width: 100%;
      }

      .template-grid {
        grid-template-columns: 1fr;
      }

      .preview-parties {
        grid-template-columns: 1fr;
      }

      .form-actions {
        flex-direction: column;
      }

      .form-actions .button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <a href="dashboard.html" class="logo-container">
        <div class="logo">
          <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <path d="M3.27 6.96L12 12.01l8.73-5.05"></path>
            <path d="M12 22.08V12"></path>
          </svg>
        </div>
        <span class="logo-text">InFree</span>
      </a>
    </div>

    <nav class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">メイン</div>
        <a href="dashboard.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <span class="nav-text">ダッシュボード</span>
        </a>
        <a href="create-invoice.html" class="nav-item active">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          <span class="nav-text">請求書作成</span>
        </a>
        <a href="invoices.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
          </svg>
          <span class="nav-text">請求書一覧</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">管理</div>
        <a href="clients.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          <span class="nav-text">顧客管理</span>
        </a>
        <a href="products.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          </svg>
          <span class="nav-text">商品・サービス</span>
        </a>
        <a href="reports.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          <span class="nav-text">レポート</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">設定</div>
        <a href="settings.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6"></path>
          </svg>
          <span class="nav-text">設定</span>
        </a>
        <a href="help.html" class="nav-item">
          <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <span class="nav-text">ヘルプ</span>
        </a>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">山</div>
        <div class="user-info">
          <div class="user-name">山田 太郎</div>
          <div class="user-email">yamada@infree.jp</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="page-header">
      <h1 class="page-title">請求書作成</h1>
    </header>

    <div class="create-container">
      <!-- Form Section -->
      <div class="form-section">
        <div class="section-header">
          <div class="section-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          </div>
          <h2 class="section-title">請求書情報</h2>
        </div>

        <form id="invoice-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">請求書番号</label>
              <input type="text" class="form-input" id="invoice-number" value="INV-2025-001" placeholder="INV-2025-001">
            </div>
            <div class="form-group">
              <label class="form-label">発行日</label>
              <input type="date" class="form-input" id="issue-date" value="2025-05-30">
            </div>
            <div class="form-group">
              <label class="form-label">支払期限</label>
              <input type="date" class="form-input" id="due-date" value="2025-06-30">
            </div>
          </div>

          <div class="section-header" style="margin-top: 32px;">
            <div class="section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <h2 class="section-title">顧客情報</h2>
          </div>

          <div class="form-group">
            <label class="form-label">顧客名</label>
            <input type="text" class="form-input" id="client-name" placeholder="株式会社サンプル">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">担当者名</label>
              <input type="text" class="form-input" id="client-contact" placeholder="山田 太郎">
            </div>
            <div class="form-group">
              <label class="form-label">メールアドレス</label>
              <input type="email" class="form-input" id="client-email" placeholder="yamada@example.com">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">住所</label>
            <textarea class="form-textarea" id="client-address" rows="2" placeholder="〒100-0001 東京都千代田区千代田1-1"></textarea>
          </div>

          <div class="section-header" style="margin-top: 32px;">
            <div class="section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              </svg>
            </div>
            <h2 class="section-title">請求項目</h2>
          </div>

          <div id="items-container">
            <div class="item-row">
              <div class="form-group">
                <label class="form-label">項目名</label>
                <input type="text" class="form-input item-name" placeholder="ウェブサイト制作">
              </div>
              <div class="form-group">
                <label class="form-label">数量</label>
                <input type="number" class="form-input item-quantity" value="1" min="1">
              </div>
              <div class="form-group">
                <label class="form-label">単価</label>
                <input type="number" class="form-input item-price" placeholder="100000" min="0">
              </div>
              <div class="form-group">
                <label class="form-label">小計</label>
                <input type="text" class="form-input item-subtotal" readonly value="¥0">
              </div>
              <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="remove-item-btn" onclick="removeItem(this)">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <button type="button" class="add-item-btn" onclick="addItem()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            項目を追加
          </button>

          <div class="section-header" style="margin-top: 32px;">
            <div class="section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
            </div>
            <h2 class="section-title">金額詳細</h2>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">消費税率 (%)</label>
              <input type="number" class="form-input" id="tax-rate" value="10" min="0" max="100">
            </div>
            <div class="form-group">
              <label class="form-label">割引 (¥)</label>
              <input type="number" class="form-input" id="discount" value="0" min="0">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">備考</label>
            <textarea class="form-textarea" id="notes" rows="3" placeholder="支払い条件やその他の注意事項を記入してください"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="button secondary">
              <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              下書きとして保存
            </button>
            <button type="submit" class="button primary">
              <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13"></path>
                <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
              </svg>
              請求書を送信
            </button>
          </div>
        </form>
      </div>

      <!-- Preview Section -->
      <div class="preview-section">
        <div class="preview-header">
          <div class="preview-logo">InFree</div>
          <div class="preview-info">
            <div class="invoice-title">請求書</div>
            <div class="invoice-number" id="preview-number">INV-2025-001</div>
          </div>
        </div>

        <div class="preview-parties">
          <div class="party-info">
            <h3>請求元</h3>
            <div class="party-details">
              <div class="party-name">株式会社InFree</div>
              <div>〒100-0001</div>
              <div>東京都千代田区千代田1-1</div>
              <div>info@infree.jp</div>
            </div>
          </div>
          <div class="party-info">
            <h3>請求先</h3>
            <div class="party-details">
              <div class="party-name" id="preview-client-name">顧客名未入力</div>
              <div id="preview-client-address">住所未入力</div>
              <div id="preview-client-email">メール未入力</div>
            </div>
          </div>
        </div>

        <div class="invoice-items">
          <table class="items-table">
            <thead>
              <tr>
                <th>項目</th>
                <th class="text-right">数量</th>
                <th class="text-right">単価</th>
                <th class="text-right">小計</th>
              </tr>
            </thead>
            <tbody id="preview-items">
              <tr>
                <td class="item-name">項目が追加されていません</td>
                <td class="text-right">-</td>
                <td class="text-right">-</td>
                <td class="text-right">¥0</td>
              </tr>
            </tbody>
          </table>

          <div class="invoice-totals">
            <div class="total-row">
              <span class="total-label">小計</span>
              <span class="total-value" id="preview-subtotal">¥0</span>
            </div>
            <div class="total-row">
              <span class="total-label">消費税 (<span id="preview-tax-rate">10</span>%)</span>
              <span class="total-value" id="preview-tax">¥0</span>
            </div>
            <div class="total-row">
              <span class="total-label">割引</span>
              <span class="total-value" id="preview-discount">¥0</span>
            </div>
            <div class="total-row grand-total">
              <span class="total-label">合計金額</span>
              <span class="total-value" id="preview-total">¥0</span>
            </div>
          </div>
        </div>

        <div class="party-info" style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #f3f4f6;">
          <h3>備考</h3>
          <div class="party-details" id="preview-notes">備考なし</div>
        </div>
      </div>
    </div>
  </main>

  <script src="utils.js"></script>
  <script>
    // Page-specific JavaScript for create-invoice
    let itemCount = 1;

    function addItem() {
      itemCount++;
      const container = document.getElementById('items-container');
      const itemRow = document.createElement('div');
      itemRow.className = 'item-row';
      itemRow.innerHTML = `
        <div class="form-group">
          <label class="form-label">項目名</label>
          <input type="text" class="form-input item-name" placeholder="項目名">
        </div>
        <div class="form-group">
          <label class="form-label">数量</label>
          <input type="number" class="form-input item-quantity" value="1" min="1">
        </div>
        <div class="form-group">
          <label class="form-label">単価</label>
          <input type="number" class="form-input item-price" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">小計</label>
          <input type="text" class="form-input item-subtotal" readonly value="¥0">
        </div>
        <div class="form-group">
          <label class="form-label">&nbsp;</label>
          <button type="button" class="remove-item-btn" onclick="removeItem(this)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
      container.appendChild(itemRow);
      attachItemListeners(itemRow);
      updatePreview();
    }

    function removeItem(button) {
      const itemRow = button.closest('.item-row');
      const container = document.getElementById('items-container');
      if (container.children.length > 1) {
        itemRow.remove();
        updatePreview();
      } else {
        alert('最低1つの項目が必要です');
      }
    }

    function attachItemListeners(itemRow) {
      const quantity = itemRow.querySelector('.item-quantity');
      const price = itemRow.querySelector('.item-price');
      const subtotal = itemRow.querySelector('.item-subtotal');
      const name = itemRow.querySelector('.item-name');

      [quantity, price, name].forEach(input => {
        input.addEventListener('input', () => {
          const qty = parseFloat(quantity.value) || 0;
          const prc = parseFloat(price.value) || 0;
          const sub = qty * prc;
          subtotal.value = '¥' + sub.toLocaleString();
          updatePreview();
        });
      });
    }

    function updatePreview() {
      // Update invoice number
      document.getElementById('preview-number').textContent =
        document.getElementById('invoice-number').value || 'INV-XXXX-XXX';

      // Update client info
      document.getElementById('preview-client-name').textContent =
        document.getElementById('client-name').value || '顧客名未入力';
      document.getElementById('preview-client-address').textContent =
        document.getElementById('client-address').value || '住所未入力';
      document.getElementById('preview-client-email').textContent =
        document.getElementById('client-email').value || 'メール未入力';

      // Update notes
      document.getElementById('preview-notes').textContent =
        document.getElementById('notes').value || '備考なし';

      // Update items
      const previewItems = document.getElementById('preview-items');
      previewItems.innerHTML = '';

      const itemRows = document.querySelectorAll('.item-row');
      let subtotal = 0;

      if (itemRows.length === 0) {
        previewItems.innerHTML = `
          <tr>
            <td class="item-name">項目が追加されていません</td>
            <td class="text-right">-</td>
            <td class="text-right">-</td>
            <td class="text-right">¥0</td>
          </tr>
        `;
      } else {
        itemRows.forEach(row => {
          const name = row.querySelector('.item-name').value || '項目名未入力';
          const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
          const price = parseFloat(row.querySelector('.item-price').value) || 0;
          const itemSubtotal = quantity * price;
          subtotal += itemSubtotal;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="item-name">${name}</td>
            <td class="text-right">${quantity}</td>
            <td class="text-right">¥${price.toLocaleString()}</td>
            <td class="text-right">¥${itemSubtotal.toLocaleString()}</td>
          `;
          previewItems.appendChild(tr);
        });
      }

      // Calculate totals
      const taxRate = parseFloat(document.getElementById('tax-rate').value) || 0;
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const tax = subtotal * (taxRate / 100);
      const total = subtotal + tax - discount;

      document.getElementById('preview-subtotal').textContent = '¥' + subtotal.toLocaleString();
      document.getElementById('preview-tax-rate').textContent = taxRate;
      document.getElementById('preview-tax').textContent = '¥' + Math.round(tax).toLocaleString();
      document.getElementById('preview-discount').textContent = '¥' + discount.toLocaleString();
      document.getElementById('preview-total').textContent = '¥' + Math.round(total).toLocaleString();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Attach listeners to initial item row
      const initialRow = document.querySelector('.item-row');
      attachItemListeners(initialRow);

      // Attach listeners to all form inputs
      document.querySelectorAll('#invoice-form input, #invoice-form textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
      });

      // Form submit
      document.getElementById('invoice-form').addEventListener('submit', (e) => {
        e.preventDefault();
        alert('請求書が送信されました！');
      });

      // Initial preview update
      updatePreview();
    });
  </script>
</body>
</html>
